{"version":3,"sources":["System/Disposable/ObjectPool.ts"],"names":[],"mappings":"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","file":"ObjectPool.js","sourcesContent":["/*!\r\n * @author electricessence / https://github.com/electricessence/\r\n * Licensing: MIT https://github.com/electricessence/TypeScript.NET/blob/master/LICENSE.md\r\n * Based upon ObjectPool from Parallel Extension Extras and other ObjectPool implementations.\r\n * Uses .add(T) and .take():T\r\n */\r\nimport {dispose} from \"./dispose\";\r\nimport {DisposableBase} from \"./DisposableBase\";\r\nimport {TaskHandler} from \"../Threading/Tasks/TaskHandler\";\r\nimport {ArgumentOutOfRangeException} from \"../Exceptions/ArgumentOutOfRangeException\";\r\nimport {ArgumentException} from \"../Exceptions/ArgumentException\";\r\nimport __extendsImport from \"../../extends\";\r\n// noinspection JSUnusedLocalSymbols\r\nconst __extends = __extendsImport;\r\n\r\nconst\r\n\tOBJECT_POOL       = \"ObjectPool\",\r\n\t_MAX_SIZE         = \"_maxSize\",\r\n\tABSOLUTE_MAX_SIZE = 65536,\r\n\tMUST_BE_GT1       = \"Must be at valid number least 1.\",\r\n\tMUST_BE_LTM       = `Must be less than or equal to ${ABSOLUTE_MAX_SIZE}.`;\r\n\r\nexport class ObjectPool<T> extends DisposableBase\r\n{\r\n\r\n\tprivate _pool:T[];\r\n\tprivate _trimmer:TaskHandler;\r\n\tprivate _flusher:TaskHandler;\r\n\tprivate _autoFlusher:TaskHandler;\r\n\r\n\t/**\r\n\t * A transient amount of object to exist over _maxSize until trim() is called.\r\n\t * But any added objects over _localAbsMaxSize will be disposed immediately.\r\n\t */\r\n\tprivate _localAbsMaxSize:number;\r\n\r\n\t/**\r\n\t * By default will clear after 5 seconds of non-use.\r\n\t */\r\n\tautoClearTimeout:number = 5000;\r\n\r\n\tconstructor(\r\n\t\tprivate _maxSize:number,\r\n\t\tprivate _generator?:(...args:any[])=>T,\r\n\t\tprivate _recycler?:(o:T)=>void)\r\n\t{\r\n\t\tsuper();\r\n\t\tif(isNaN(_maxSize) || _maxSize<1)\r\n\t\t\tthrow new ArgumentOutOfRangeException(_MAX_SIZE, _maxSize, MUST_BE_GT1);\r\n\t\tif(_maxSize>ABSOLUTE_MAX_SIZE)\r\n\t\t\tthrow new ArgumentOutOfRangeException(_MAX_SIZE, _maxSize, MUST_BE_LTM);\r\n\r\n\t\tthis._localAbsMaxSize = Math.min(_maxSize*2, ABSOLUTE_MAX_SIZE);\r\n\r\n\t\tconst _ = this;\r\n\t\t_._disposableObjectName = OBJECT_POOL;\r\n\t\t_._pool = [];\r\n\t\t_._trimmer = new TaskHandler(()=>_._trim());\r\n\t\tconst clear = () => _._clear();\r\n\t\t_._flusher = new TaskHandler(clear);\r\n\t\t_._autoFlusher = new TaskHandler(clear);\r\n\t}\r\n\r\n\t/**\r\n\t * Defines the maximum at which trimming should allow.\r\n\t * @returns {number}\r\n\t */\r\n\tget maxSize():number\r\n\t{\r\n\t\treturn this._maxSize;\r\n\t}\r\n\r\n\t/**\r\n\t * Current number of objects in pool.\r\n\t * @returns {number}\r\n\t */\r\n\tget count():number\r\n\t{\r\n\t\tconst p = this._pool;\r\n\t\treturn p ? p.length : 0;\r\n\t}\r\n\r\n\tprotected _trim():void\r\n\t{\r\n\t\tconst pool = this._pool;\r\n\t\twhile(pool.length>this._maxSize)\r\n\t\t{\r\n\t\t\tdispose.single(<any>pool.pop(),true);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Will trim ensure the pool is less than the maxSize.\r\n\t * @param defer A delay before trimming.  Will be overridden by later calls.\r\n\t */\r\n\ttrim(defer?:number):void\r\n\t{\r\n\t\tthis.throwIfDisposed();\r\n\t\tthis._trimmer.start(defer);\r\n\t}\r\n\r\n\tprotected _clear():void\r\n\t{\r\n\t\tconst _ = this;\r\n\t\tconst p = _._pool;\r\n\t\t_._trimmer.cancel();\r\n\t\t_._flusher.cancel();\r\n\t\t_._autoFlusher.cancel();\r\n\t\tdispose.these.noCopy(<any>p, true);\r\n\t\tp.length = 0;\r\n\t}\r\n\r\n\t/**\r\n\t * Will clear out the pool.\r\n\t * Cancels any scheduled trims when executed.\r\n\t * @param defer A delay before clearing.  Will be overridden by later calls.\r\n\t */\r\n\tclear(defer?:number):void\r\n\t{\r\n\t\tthis.throwIfDisposed();\r\n\t\tthis._flusher.start(defer);\r\n\t}\r\n\r\n\ttoArrayAndClear():T[]\r\n\t{\r\n\t\tconst _ = this;\r\n\t\t_.throwIfDisposed();\r\n\t\t_._trimmer.cancel();\r\n\t\t_._flusher.cancel();\r\n\t\tconst p = _._pool;\r\n\t\t_._pool = [];\r\n\t\treturn p;\r\n\t}\r\n\r\n\t/**\r\n\t * Shortcut for toArrayAndClear();\r\n\t */\r\n\tdump():T[]\r\n\t{\r\n\t\treturn this.toArrayAndClear();\r\n\t}\r\n\r\n\r\n\tprotected _onDispose():void\r\n\t{\r\n\t\tsuper._onDispose();\r\n\t\tconst _:any = this;\r\n\t\t_._generator = null;\r\n\t\t_._recycler = null;\r\n\t\tdispose(\r\n\t\t\t_._trimmer,\r\n\t\t\t_._flusher,\r\n\t\t\t_._autoFlusher\r\n\t\t);\r\n\t\t_._trimmer = null;\r\n\t\t_._flusher = null;\r\n\t\t_._autoFlusher = null;\r\n\r\n\t\t_._pool.length = 0;\r\n\t\t_._pool = null;\r\n\t}\r\n\r\n\textendAutoClear():void\r\n\t{\r\n\t\tconst _ = this;\r\n\t\t_.throwIfDisposed();\r\n\t\tconst t = _.autoClearTimeout;\r\n\t\tif(isFinite(t) && !_._autoFlusher.isScheduled)\r\n\t\t\t_._autoFlusher.start(t);\r\n\t}\r\n\r\n\tadd(o:T):void\r\n\t{\r\n\t\tconst _ = this;\r\n\t\t_.throwIfDisposed();\r\n\t\tif(_._pool.length>=_._localAbsMaxSize)\r\n\t\t{\r\n\t\t\t// Getting too big, dispose immediately...\r\n\t\t\tdispose(<any>o);\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tif(_._recycler) _._recycler(o);\r\n\t\t\t_._pool.push(o);\r\n\t\t\tconst m = _._maxSize;\r\n\t\t\tif(m<ABSOLUTE_MAX_SIZE && _._pool.length>m)\r\n\t\t\t\t_._trimmer.start(500);\r\n\t\t}\r\n\t\t_.extendAutoClear();\r\n\r\n\t}\r\n\r\n\tprivate _onTaken():void\r\n\t{\r\n\t\tconst _ = this, len = _._pool.length;\r\n\t\tif(len<=_._maxSize)\r\n\t\t\t_._trimmer.cancel();\r\n\t\tif(len)\r\n\t\t\t_.extendAutoClear();\r\n\t}\r\n\r\n\ttryTake():T|undefined\r\n\t{\r\n\t\tconst _ = this;\r\n\t\t_.throwIfDisposed();\r\n\r\n\t\ttry\r\n\t\t{\r\n\t\t\treturn _._pool.pop();\r\n\t\t}\r\n\t\tfinally\r\n\t\t{\r\n\t\t\t_._onTaken();\r\n\t\t}\r\n\t}\r\n\r\n\ttake(factory?:()=>T):T\r\n\t{\r\n\t\tconst _ = this;\r\n\t\t_.throwIfDisposed();\r\n\t\tif(!_._generator && !factory)\r\n\t\t\tthrow new ArgumentException('factory', \"Must provide a factory if on was not provided at construction time.\");\r\n\r\n\t\ttry\r\n\t\t{\r\n\t\t\treturn _._pool.pop() || factory && factory() || _._generator!();\r\n\t\t}\r\n\t\tfinally\r\n\t\t{\r\n\t\t\t_._onTaken();\r\n\t\t}\r\n\t}\r\n\r\n\r\n}\r\n\r\nexport default ObjectPool;\r\n"]}